name: Upload packages from dist/ to PyPI
description: 'Uses twine to upload packages from dist/ to public or private PyPI'
inputs:
  pypi_pass:
    required: true
    description: 'Password of PyPI repository'

  github_token:
    required: false
    description: 'GitHub token'
    default: 'dummy'
  pypi_name:
    required: false
    description: 'Name of PyPI repository'
    default: 'pypi'
  pypi_host:
    required: false
    description: 'Host of PyPI repository'
    default: 'https://upload.pypi.org/legacy/'
  pypi_user:
    required: false
    description: 'Username of PyPI repository'
    default: '__token__'

runs:
  using: 'composite'
  steps:
  - id: check-version-format
    run: |
      if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
        echo "Invalid version format. Expected MAJOR.MINOR.PATCH(-SUFFIX)?, got ${{ inputs.version }}"
        exit 1
      fi
    shell: bash

  - id: install-tools
    shell: bash
    run: |
      python3 -m pip install --upgrade twine

  - id: setup-pypirc
    shell: bash
    run: |
      echo "[distutils]
      index-servers=
          ${{ inputs.pypi_name }}

      [${{ inputs.pypi_name }}]
      repository: https://${{ inputs.pypi_host }}
      username: ${{ inputs.pypi_user }}
      password: ${{ inputs.pypi_pass }}
      " > ~/.pypirc

  - id: upload
    shell: bash
    run: |
      python3 -m twine upload --repository ${{inputs.pypi_name}} --skip-existing --disable-progress-bar dist/*
